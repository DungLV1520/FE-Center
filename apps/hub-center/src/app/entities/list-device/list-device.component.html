<hub-loading></hub-loading>
<div class="user-list-wrapper">
  <div class="filter-header">
    <div class="search-box">
      <nz-input-group [nzSuffix]="suffixIconSearch" nzSize="large">
        <input
          type="text"
          nz-input
          placeholder="Tìm kiếm theo tên, series thiết bị"
          [formControl]="searchForm"
        />
      </nz-input-group>
      <ng-template #suffixIconSearch>
        <span nz-icon nzType="search"></span>
      </ng-template>
    </div>
    <div class="btn-action-group">
      <button
        nz-button
        nzType="default"
        class="create-team"
        nzSize="large"
        (click)="onShowModeTable()"
      >
        <ng-container *ngIf="!isModeViewTable">
          <span nz-icon nzType="table" nzTheme="outline"></span>
          <span>Chế độ xem: bảng</span>
        </ng-container>
        <ng-container *ngIf="isModeViewTable">
          <span nz-icon nzType="appstore" nzTheme="outline"></span>
          <span>Chế độ xem: lưới</span>
        </ng-container>
      </button>
      <button
        (click)="reloadPage()"
        nz-button
        nzType="default"
        class="create-team"
        nzSize="large"
      >
        <span nz-icon nzType="reload" nzTheme="outline"></span>
        <span>Cập nhật danh sách</span>
      </button>
    </div>
  </div>
  <div class="device-info">
    <div>
      <nz-tag>Tổng: {{ totalDevicesCount }}</nz-tag>
      <nz-tag [nzColor]="'green'"
        >Đang hoạt động: {{ totalDevicesOnlineCount }}</nz-tag
      >
      <nz-tag [nzColor]="'red'"
        >Mất kết nối: {{ totalDevicesOfflineCount }}</nz-tag
      >
    </div>

    <div *ngIf="!isModeViewTable">
      <nz-tag *ngIf="allDevices.length > 0"
        ><span>Đã chọn {{ checkedId?.length! }}</span>
        <div
          style="display: inline-flex; margin-left: 5px; cursor: pointer"
          (click)="resetCheck()"
        >
          <span class="anticon anticon-close"
            ><svg
              style="padding-bottom: 1px"
              fill-rule="evenodd"
              viewBox="64 64 896 896"
              focusable="false"
              fill="currentColor"
              width="1em"
              height="1em"
              data-icon="close"
              aria-hidden="true"
              class=""
            >
              <path
                d="M799.86 166.31c.02 0 .04.02.08.06l57.69 57.7c.04.03.05.05.06.08a.12.12 0 010 .06c0 .03-.02.05-.06.09L569.93 512l287.7 287.7c.04.04.05.06.06.09a.12.12 0 010 .07c0 .02-.02.04-.06.08l-57.7 57.69c-.03.04-.05.05-.07.06a.12.12 0 01-.07 0c-.03 0-.05-.02-.09-.06L512 569.93l-287.7 287.7c-.04.04-.06.05-.09.06a.12.12 0 01-.07 0c-.02 0-.04-.02-.08-.06l-57.69-57.7c-.04-.03-.05-.05-.06-.07a.12.12 0 010-.07c0-.03.02-.05.06-.09L454.07 512l-287.7-287.7c-.04-.04-.05-.06-.06-.09a.12.12 0 010-.07c0-.02.02-.04.06-.08l57.7-57.69c.03-.04.05-.05.07-.06a.12.12 0 01.07 0c.03 0 .05.02.09.06L512 454.07l287.7-287.7c.04-.04.06-.05.09-.06a.12.12 0 01.07 0z"
              ></path></svg
          ></span>
        </div>
      </nz-tag>
      <button
        [disabled]="allDevices!.length === 0"
        (click)="checkAll()"
        nz-button
        nzType="default"
        nzSize="small"
        class="mx-2"
      >
        <span>Chọn tất cả</span>
      </button>

      <button
        nz-button
        nzType="default"
        nzSize="small"
        [disabled]="checkedId!.length === 0"
        (click)="moveFile()"
      >
        <span>Di chuyển</span>
      </button>
    </div>
  </div>
  <div class="content-wrapper">
    <div *ngIf="isModeViewTable" class="table-body" style="overflow: auto">
      <nz-table
        *ngIf="devices$ | async as devices"
        #filterTable
        [nzFrontPagination]="false"
        [nzShowPagination]="false"
        [nzData]="devices || []"
      >
        <thead>
          <tr>
            <th
              *ngFor="let column of listOfColumn"
              [ngStyle]="{
                width: column.priority === 0 ? '68px' : '100%',
                whiteSpace: 'nowrap'
              }"
            >
              {{ column.title }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of devices; let i = index">
            <td nz>{{ i + 1 }}</td>
            <td>
              {{ data.name ? data.name : '--' }}
            </td>
            <td>
              <nz-tag [nzColor]="data?.available ? 'green' : 'red'">{{
                data.available ? 'Đang hoạt động' : 'Mất kết nối'
              }}</nz-tag>
            </td>
            <td>
              <nz-tag [nzColor]="data.isPresenting ? 'green' : 'red'">{{
                data?.isPresenting ? 'Đang trình chiếu' : 'Không trình chiếu'
              }}</nz-tag>
            </td>
            <td>{{ data.isPresenting ? data.isPresenting : '--' }}</td>
            <td>
              {{
                data.lastDisconnectedTime
                  ? (data.lastDisconnectedTime | date : 'HH:mm dd/MM/yyyy')
                  : '--'
              }}
            </td>
            <td>
              {{ calculateTimeAgo(data.timeOffAgo) ?? '--' }}
            </td>
            <td>
              {{ data.location ? data.location : '--' }}
            </td>
            <td>{{ data.model ? data.model : '--' }}</td>

            <td>{{ data.serialNumber ? data.serialNumber : '--' }}</td>
            <td>{{ data.manufacturer ? data.manufacturer : '--' }}</td>
            <td>{{ data.appVersion ? data.appVersion : '--' }}</td>
            <td>{{ data.osVersion ? data.osVersion : '--' }}</td>
            <td style="cursor: pointer">
              <span
                nz-icon
                nzType="more"
                nzTheme="outline"
                nz-dropdown
                [nzDropdownMenu]="moreAction"
              ></span>
              <nz-dropdown-menu #moreAction="nzDropdownMenu">
                <ul nz-menu>
                  <li
                    nz-menu-item
                    (click)="onViewDetailPresentation(data.identityDevice)"
                  >
                    Thiết lập lịch trình chiếu
                  </li>
                  <li nz-menu-item (click)="moveFile(data)">Di chuyển</li>
                  <li nz-menu-item (click)="renameDevice(data.id, data.name)">
                    Đổi tên
                  </li>
                  <li
                    style="color: #a00705"
                    nz-menu-item
                    (click)="onConfirmDeleteDevice(data.id, data.name)"
                  >
                    Xoá thiết bị
                  </li>
                </ul>
              </nz-dropdown-menu>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
    <div
      *ngIf="!isModeViewTable && allDevices.length > 0; else noDataDevice"
      class="grid-body"
    >
      <div
        *ngFor="let device of devices$ | async; let i = index"
        class="grid-item"
        nz-popover
        nzPopoverTitle="{{ device.name }}"
        [nzPopoverContent]="contentTemplate"
        nzPopoverTrigger="hover"
        [ngClass]="{ 'bg-active': checked![i] }"
      >
        <div class="device-name">
          <label
            nz-checkbox
            [(ngModel)]="checked![i]"
            (click)="chooseDevice(device)"
            >{{ device?.name }}</label
          >
        </div>
        <div class="device-status">
          <span *ngIf="device.available" nz-icon>
            <svg
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="8" cy="8" r="8" fill="#52C41A" />
            </svg>
          </span>
          <span *ngIf="!device.available" nz-icon>
            <svg
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="8" cy="8" r="8" fill="#F5222D" />
            </svg>
          </span>
          <span class="time-desc">
            {{ calculateTimeAgo(device.timeOffAgo) }}</span
          >
        </div>
        <div class="device-play-desc">
          <nz-tag [nzColor]="device.isPresenting ? '#5F7EEB' : '#D9D9D9'">{{
            device.isPresenting ? 'Đang trình chiếu' : 'Không trình chiếu'
          }}</nz-tag>
          <div class="icon-more-action" (click)="$event.stopPropagation()">
            <span
              nz-icon
              nzType="more"
              nzTheme="outline"
              nz-dropdown
              nzTrigger="click"
              [nzDropdownMenu]="moreAction"
            ></span>
            <nz-dropdown-menu #moreAction="nzDropdownMenu">
              <ul nz-menu>
                <li
                  nz-menu-item
                  (click)="onViewDetailPresentation(device.identityDevice)"
                >
                  Thiết lập lịch trình chiếu
                </li>
                <li nz-menu-item (click)="moveFile(device)">Di chuyển</li>
                <li nz-menu-item (click)="renameDevice(device.id, device.name)">
                  Đổi tên
                </li>
                <li
                  style="color: #a00705"
                  nz-menu-item
                  (click)="onConfirmDeleteDevice(device.id, device.name)"
                >
                  Xoá thiết bị
                </li>
              </ul>
            </nz-dropdown-menu>
          </div>
        </div>
        <ng-template #contentTemplate>
          <div>
            <div>Model máy: {{ device.model }}</div>
            <div>Số seri: {{ device.serialNumber }}</div>
            <div>Hãng sản xuất: {{ device.manufacturer }}</div>
            <div>Phiên bản app: {{ device.appVersion }}</div>
            <div>Phiên bản hệ điều hành: {{ device.osVersion }}</div>
            <div>Vị trí: {{ device.location }}</div>
          </div>
        </ng-template>
      </div>
    </div>
    <ng-template #noDataDevice>
      <div class="empty-data-device">
        <nz-empty nzNotFoundImage="simple"></nz-empty>
      </div>
    </ng-template>
  </div>
  <div class="pagination-footer">
    <nz-pagination
      [nzPageIndex]="currentPage$ | async"
      [nzTotal]="totalDevicesCount"
      [nzPageSize]="pageSize"
      (nzPageIndexChange)="handlePageChange($event)"
    ></nz-pagination>
  </div>
</div>
